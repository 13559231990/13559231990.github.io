<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>移动端贪吃蛇</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #1a1a1a;
            font-family: "Arial", sans-serif;
            padding: 10px;
        }

        .game-info {
            color: #ffffff;
            margin-bottom: 15px;
            text-align: center;
        }

        .game-title {
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: #4cd964;
        }

        .game-creator {
            font-size: 0.9rem;
            color: #999999;
            margin-bottom: 8px;
        }

        .score-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .player-score {
            color: #4cd964;
        }

        .ai-score {
            color: #03a9f4;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .diff-btn, .mode-btn {
            padding: 6px 12px;
            border: 1px solid #4cd964;
            border-radius: 4px;
            background-color: transparent;
            color: #f0f0f0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .diff-btn.active, .mode-btn.active {
            background-color: #4cd964;
            color: #1a1a1a;
            font-weight: bold;
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            border: 2px solid #4cd964;
            border-radius: 8px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            background-color: #2c2c2c;
        }

        .game-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff3b30;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 10;
        }

        #gameOver {
            color: #ff3b30;
        }

        #vsResult {
            color: #4cd964;
        }

        .control-panel {
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
            display: grid;
            grid-template-areas:
                ". up ."
                "left down right";
            grid-gap: 10px;
            justify-items: center;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border: none;
            border-radius: 50%;
            background-color: #4cd964;
            color: #1a1a1a;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: background-color 0.2s ease;
        }

        .control-btn:active {
            background-color: #3bc053;
            transform: scale(0.95);
        }

        #up { grid-area: up; }
        #left { grid-area: left; }
        #down { grid-area: down; }
        #right { grid-area: right; }

        @media (max-width: 375px) {
            .control-btn {
                width: 70px;
                height: 70px;
                font-size: 1.2rem;
            }

            .game-title {
                font-size: 1.8rem;
            }

            .diff-btn, .mode-btn {
                padding: 4px 10px;
                font-size: 0.8rem;
            }

            .game-creator {
                font-size: 0.8rem;
            }

            .score-group {
                gap: 10px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-info">
        <h1 class="game-title">贪吃蛇</h1>
        <p class="game-creator">本游戏由多多制作</p>
        <div class="score-group">
            <p class="player-score">玩家得分: <span id="playerScore">0</span></p>
            <p class="ai-score" id="aiScoreDisplay" style="display: none;">AI得分: <span id="aiScore">0</span></p>
        </div>
        <div class="btn-group">
            <button class="diff-btn active" id="easy">简单(+1)</button>
            <button class="diff-btn" id="medium">中等(+2)</button>
            <button class="diff-btn" id="hard">困难(+5)</button>
            <button class="mode-btn active" id="singleMode">单人模式</button>
            <button class="mode-btn" id="vsMode">人机对战</button>
            <button class="mode-btn" id="aiToggle" style="display: none;">AI单人: 关闭</button>
        </div>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="game-tip" id="gameOver">
            游戏结束!<br>
            点击屏幕重新开始
        </div>
        <div class="game-tip" id="vsResult">
            对战结束!<br>
            <span id="resultText">玩家获胜!</span><br>
            点击屏幕重新开始
        </div>
    </div>

    <div class="control-panel">
        <button class="control-btn" id="up">↑</button>
        <button class="control-btn" id="left">←</button>
        <button class="control-btn" id="down">↓</button>
        <button class="control-btn" id="right">→</button>
    </div>

    <script>
        // 难度配置
        const difficultyConfig = {
            easy: { speed: 180, score: 1 },
            medium: { speed: 120, score: 2 },
            hard: { speed: 70, score: 5 }
        };

        // 特殊食物配置
        const specialFoodList = [
            { type: "double", color: "#9c27b0", probability: 0.1, effect: s => s*2 },
            { type: "triple", color: "#ff9800", probability: 0.08, effect: s => s*3 },
            { type: "speedUp", color: "#e91e63", probability: 0.12, effect: (s, o) => { o.tempSpeed = o.baseSpeed*0.7; setTimeout(()=>o.tempSpeed=null,5000); return s; } },
            { type: "slim", color: "#03a9f4", probability: 0.1, effect: (s, o) => { while(o.snake.length>3) o.snake.pop(); return s*1.5; } }
        ];

        // 全局变量
        let currentDifficulty = "easy"; // 改为简单难度启动更稳定
        let currentMode = "single";
        let isSingleAIEnabled = false;

        // 游戏核心对象（初始化赋默认值，避免undefined）
        const game = {
            canvas: null,
            ctx: null,
            gridSize: 20,
            borderColor: "#2c2c2c",
            normalFoodColor: "#ff3b30",
            food: { x: 0, y: 0 },
            foodType: "normal",
            player: {
                snake: [],
                direction: "right",
                nextDirection: "right",
                color: "#4cd964",
                score: 0,
                baseSpeed: 180,
                tempSpeed: null,
                isDead: false
            },
            ai: {
                snake: [],
                direction: "left",
                nextDirection: "left",
                color: "#03a9f4",
                score: 0,
                baseSpeed: 180,
                tempSpeed: null,
                isDead: false
            },
            gameLoop: null,
            isGameOver: false
        };

        // 页面加载完成后立即初始化（确保DOM已渲染）
        window.addEventListener("load", function() {
            game.canvas = document.getElementById("gameCanvas");
            game.ctx = game.canvas.getContext("2d");
            // 强制设置画布尺寸（避免容器未渲染导致尺寸为0）
            game.canvas.width = game.canvas.parentElement.clientWidth;
            game.canvas.height = game.canvas.parentElement.clientHeight;
            game.gridSize = Math.max(15, Math.floor(Math.min(game.canvas.width, game.canvas.height)/20));
            
            bindAllButtons();
            initGame();
            // 监听窗口大小变化
            window.addEventListener("resize", resizeCanvas);
        });

        // 画布尺寸自适应
        function resizeCanvas() {
            game.canvas.width = game.canvas.parentElement.clientWidth;
            game.canvas.height = game.canvas.parentElement.clientHeight;
            game.gridSize = Math.max(15, Math.floor(Math.min(game.canvas.width, game.canvas.height)/20));
            if(!game.isGameOver) renderGame();
        }

        // 绑定所有按钮事件
        function bindAllButtons() {
            // 难度按钮
            document.querySelectorAll(".diff-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".diff-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentDifficulty = btn.id;
                    game.player.baseSpeed = difficultyConfig[currentDifficulty].speed;
                    game.ai.baseSpeed = difficultyConfig[currentDifficulty].speed;
                    initGame();
                });
            });

            // 单人模式
            document.getElementById("singleMode").addEventListener("click", () => {
                currentMode = "single";
                document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
                document.getElementById("singleMode").classList.add("active");
                document.getElementById("aiToggle").style.display = "inline-block";
                document.getElementById("aiScoreDisplay").style.display = "none";
                isSingleAIEnabled = false;
                document.getElementById("aiToggle").textContent = "AI单人: 关闭";
                document.getElementById("aiToggle").classList.remove("active");
                initGame();
            });

            // 对战模式
            document.getElementById("vsMode").addEventListener("click", () => {
                currentMode = "vs";
                document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
                document.getElementById("vsMode").classList.add("active");
                document.getElementById("aiToggle").style.display = "none";
                document.getElementById("aiScoreDisplay").style.display = "inline-block";
                initGame();
            });

            // AI单人开关
            document.getElementById("aiToggle").addEventListener("click", () => {
                if(currentMode !== "single") return;
                isSingleAIEnabled = !isSingleAIEnabled;
                const btn = document.getElementById("aiToggle");
                btn.textContent = isSingleAIEnabled ? "AI单人: 开启" : "AI单人: 关闭";
                btn.classList.toggle("active");
            });

            // 方向按钮
            const dirBtns = {
                up: () => game.player.nextDirection = "up",
                down: () => game.player.nextDirection = "down",
                left: () => game.player.nextDirection = "left",
                right: () => game.player.nextDirection = "right"
            };
            Object.keys(dirBtns).forEach(key => {
                document.getElementById(key).addEventListener("click", () => {
                    if(game.player.isDead || isSingleAIEnabled) return;
                    const oppo = {up:"down", down:"up", left:"right", right:"left"};
                    if(game.player.direction !== oppo[key]) dirBtns[key]();
                });
            });

            // 重启游戏
            document.querySelector(".game-container").addEventListener("click", () => {
                if(game.isGameOver) initGame();
            });

            // 键盘控制
            document.addEventListener("keydown", e => {
                if(game.isGameOver || isSingleAIEnabled) return;
                const oppo = {ArrowUp:"down", ArrowDown:"up", ArrowLeft:"right", ArrowRight:"left"};
                const dirMap = {ArrowUp:"up", ArrowDown:"down", ArrowLeft:"left", ArrowRight:"right"};
                if(dirMap[e.key] && game.player.direction !== oppo[e.key]) {
                    game.player.nextDirection = dirMap[e.key];
                }
            });
        }

        // 初始化游戏（核心修复：确保蛇位置在画布内）
        function initGame() {
            // 重置所有状态
            game.isGameOver = false;
            game.player.isDead = false;
            game.ai.isDead = false;
            game.player.tempSpeed = null;
            game.ai.tempSpeed = null;
            document.getElementById("gameOver").style.display = "none";
            document.getElementById("vsResult").style.display = "none";

            // 重置得分
            game.player.score = 0;
            game.ai.score = 0;
            document.getElementById("playerScore").textContent = 0;
            document.getElementById("aiScore").textContent = 0;

            // 计算安全的初始位置（确保蛇在画布内）
            const maxX = game.canvas.width - game.gridSize*3;
            const maxY = game.canvas.height - game.gridSize*3;
            const startX = Math.max(game.gridSize*2, Math.floor(maxX/2));
            const startY = Math.max(game.gridSize*2, Math.floor(maxY/2));

            // 玩家蛇初始位置
            game.player.snake = [
                {x: startX + game.gridSize*2, y: startY},
                {x: startX + game.gridSize, y: startY},
                {x: startX, y: startY}
            ];
            game.player.direction = "right";
            game.player.nextDirection = "right";

            // AI蛇初始位置（对战模式）
            const aiStartY = Math.max(game.gridSize*2, Math.floor((game.canvas.height - game.gridSize*3)/2)*2);
            game.ai.snake = [
                {x: startX, y: aiStartY},
                {x: startX + game.gridSize, y: aiStartY},
                {x: startX + game.gridSize*2, y: aiStartY}
            ];
            game.ai.direction = "left";
            game.ai.nextDirection = "left";

            // 生成食物
            generateFood();

            // 启动游戏循环（先清旧循环，避免多线程冲突）
            if(game.gameLoop) clearInterval(game.gameLoop);
            game.gameLoop = setInterval(updateGame, game.player.baseSpeed);
        }

        // 生成食物（确保不越界、不与蛇重叠）
        function generateFood() {
            const maxX = Math.floor((game.canvas.width - game.gridSize)/game.gridSize);
            const maxY = Math.floor((game.canvas.height - game.gridSize)/game.gridSize);
            
            // 随机食物类型
            const rand = Math.random();
            let cumulativeProb = 0;
            game.foodType = "normal";
            for(const sf of specialFoodList) {
                cumulativeProb += sf.probability;
                if(rand <= cumulativeProb) {
                    game.foodType = sf.type;
                    break;
                }
            }

            // 生成不重叠的食物位置
            let foodX, foodY;
            do {
                foodX = Math.floor(Math.random()*maxX) * game.gridSize;
                foodY = Math.floor(Math.random()*maxY) * game.gridSize;
            } while(
                game.player.snake.some(s => s.x === foodX && s.y === foodY) ||
                (currentMode === "vs" && game.ai.snake.some(s => s.x === foodX && s.y === foodY))
            );
            game.food.x = foodX;
            game.food.y = foodY;
        }

        // AI寻路逻辑
        function aiAutoMove(isVsMode) {
            const snake = isVsMode ? game.ai.snake : game.player.snake;
            const dir = isVsMode ? game.ai.direction : game.player.direction;
            const targetX = game.food.x;
            const targetY = game.food.y;
            const grid = game.gridSize;
            const oppo = {up:"down", down:"up", left:"right", right:"left"};
            const dirs = ["up","down","left","right"];

            // 优先方向
            let preferred = [];
            if(snake[0].x < targetX) preferred.push("right");
            else if(snake[0].x > targetX) preferred.push("left");
            if(snake[0].y < targetY) preferred.push("down");
            else if(snake[0].y > targetY) preferred.push("up");
            preferred = preferred.concat(dirs.filter(d => !preferred.includes(d)));

            // 选安全方向
            for(const d of preferred) {
                if(d === oppo[dir]) continue;
                let x = snake[0].x, y = snake[0].y;
                switch(d) {
                    case "up": y -= grid; break;
                    case "down": y += grid; break;
                    case "left": x -= grid; break;
                    case "right": x += grid; break;
                }
                // 边界检测
                if(x <0 || x >= game.canvas.width || y <0 || y >= game.canvas.height) continue;
                // 自身碰撞
                if(snake.some(s => s.x ===x && s.y === y)) continue;
                // 对战模式检测玩家蛇
                if(isVsMode && game.player.snake.some(s => s.x ===x && s.y === y)) continue;
                
                if(isVsMode) game.ai.nextDirection = d;
                else game.player.nextDirection = d;
                return;
            }

            // 无安全方向随机选
            const avail = dirs.filter(d => d !== oppo[dir]);
            if(isVsMode) game.ai.nextDirection = avail[Math.floor(Math.random()*avail.length)];
            else game.player.nextDirection = avail[Math.floor(Math.random()*avail.length)];
        }

        // 更新蛇状态
        function updateSnake(owner) {
            const s = game[owner];
            s.direction = s.nextDirection;
            const head = {...s.snake[0]};

            // 移动蛇头
            switch(s.direction) {
                case "up": head.y -= game.gridSize; break;
                case "down": head.y += game.gridSize; break;
                case "left": head.x -= game.gridSize; break;
                case "right": head.x += game.gridSize; break;
            }
            s.snake.unshift(head);

            // 碰撞检测
            const outBound = head.x <0 || head.x >= game.canvas.width || head.y <0 || head.y >= game.canvas.height;
            const hitSelf = s.snake.slice(1).some(seg => seg.x === head.x && seg.y === head.y);
            const hitOther = currentMode === "vs" && (owner === "player" ? game.ai.snake : game.player.snake).some(seg => seg.x === head.x && seg.y === head.y);
            
            if(outBound || hitSelf || hitOther) {
                s.isDead = true;
                return;
            }

            // 吃食物
            if(head.x === game.food.x && head.y === game.food.y) {
                const base = difficultyConfig[currentDifficulty].score;
                let add = base;
                if(game.foodType !== "normal") {
                    const sf = specialFoodList.find(item => item.type === game.foodType);
                    add = sf.effect(base, s);
                }
                s.score += add;
                document.getElementById(owner === "player" ? "playerScore" : "aiScore").textContent = s.score;
                generateFood();
            } else {
                s.snake.pop();
            }

            // 速度更新
            const speed = s.tempSpeed || s.baseSpeed;
            if(owner === "player" && game.gameLoop) {
                clearInterval(game.gameLoop);
                game.gameLoop = setInterval(updateGame, speed);
            }
        }

        // 游戏主循环
        function updateGame() {
            if(game.isGameOver) return;

            // AI控制
            if(currentMode === "single" && isSingleAIEnabled) aiAutoMove(false);
            else if(currentMode === "vs") aiAutoMove(true);

            // 更新蛇
            if(!game.player.isDead) updateSnake("player");
            if(currentMode === "vs" && !game.ai.isDead) updateSnake("ai");

            // 胜负判断
            if(currentMode === "vs") {
                if(game.player.isDead && game.ai.isDead) endVsGame("平局!");
                else if(game.player.isDead) endVsGame("AI获胜!");
                else if(game.ai.isDead) endVsGame("玩家获胜!");
            } else {
                if(game.player.isDead) {
                    game.isGameOver = true;
                    clearInterval(game.gameLoop);
                    document.getElementById("gameOver").style.display = "block";
                }
            }

            renderGame();
        }

        // 结束对战
        function endVsGame(result) {
            game.isGameOver = true;
            clearInterval(game.gameLoop);
            document.getElementById("resultText").textContent = result;
            document.getElementById("vsResult").style.display = "block";
        }

        // 绘制游戏画面
        function renderGame() {
            // 清空画布
            game.ctx.fillStyle = game.borderColor;
            game.ctx.fillRect(0,0,game.canvas.width,game.canvas.height);

            // 绘制玩家蛇
            game.ctx.fillStyle = game.player.color;
            game.player.snake.forEach(seg => {
                game.ctx.fillRect(seg.x, seg.y, game.gridSize-1, game.gridSize-1);
            });

            // 绘制AI蛇（对战模式）
            if(currentMode === "vs") {
                game.ctx.fillStyle = game.ai.color;
                game.ai.snake.forEach(seg => {
                    game.ctx.fillRect(seg.x, seg.y, game.gridSize-1, game.gridSize-1);
                });
            }

            // 绘制食物
            let foodColor = game.normalFoodColor;
            if(game.foodType !== "normal") {
                const sf = specialFoodList.find(item => item.type === game.foodType);
                foodColor = sf.color;
            }
            game.ctx.fillStyle = foodColor;
            game.ctx.fillRect(game.food.x, game.food.y, game.gridSize-1, game.gridSize-1);
        }
    </script>
</body>
</html>
